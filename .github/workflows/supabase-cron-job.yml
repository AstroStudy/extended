name: Randomly Scheduled Supabase Function Trigger

on:
  schedule:
    # Runs every day at 05:00 UTC
    - cron: '0 5 * * *'
  workflow_dispatch:
    # Allows manual triggering

# REQUIRED: Permission to commit the keep-alive change
permissions:
  contents: write

jobs:
  trigger_search_function:
    runs-on: ubuntu-latest
    
    # Define environment variables
    env:
      SUPABASE_URL: https://jusjpremtvalmqqtaoth.supabase.co
      FUNCTION_NAME: search-videos
      SEARCH_TERM: "GS2025BK2519879"
      RANDOM_THRESHOLD: 20 # 20% chance = approx once every 5 days

    steps:
      # 1. Checkout is required FIRST so we can access git history later
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. Calculate if we should run the Supabase function today
      - name: ðŸŽ² Calculate Random Decision
        id: random_check
        run: |
          # Generate a random number between 1 and 100
          RANDOM_NUM=$((1 + $RANDOM % 100))
          
          echo "Random Number: $RANDOM_NUM"
          echo "Probability Threshold: ${{ env.RANDOM_THRESHOLD }}"
          
          # Logic: If Random Number <= 20, we run.
          if [ "$RANDOM_NUM" -le "${{ env.RANDOM_THRESHOLD }}" ]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "Random check passed. Proceeding with function call."
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "Random check failed. Skipping function call."
          fi

      # 3. Call Supabase (Only if Random Check passed OR Manual Trigger)
      - name: ðŸ“ž Call Supabase Edge Function
        if: steps.random_check.outputs.should_run == 'true' || github.event_name == 'workflow_dispatch'
        env:
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          FUNCTION_ENDPOINT="${{ env.SUPABASE_URL }}/functions/v1/${{ env.FUNCTION_NAME }}"
          
          # Construct JSON payload securely
          # We escape the quotes for the JSON string
          PAYLOAD="{\"searchTerm\": \"${{ env.SEARCH_TERM }}\"}"
          
          echo "Executing scheduled function call..."
          
          curl -s -X POST "${FUNCTION_ENDPOINT}" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $SUPABASE_ANON_KEY" \
            --data-raw "$PAYLOAD" \
            --fail-with-body

      # 4. Keepalive Logic (Runs ALWAYS to prevent 60-day disable)
      - name: Auto-commit to prevent inactivity
        if: always() # Ensures this runs even if the Supabase step is skipped
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          last_commit=$(git log -1 --format=%ct)
          now=$(date +%s)
          seconds_since=$((now - last_commit))
          days_since=$((seconds_since / 86400))
          
          echo "Days since last commit: $days_since"

          # If more than 50 days have passed, push a dummy update
          if [ "$days_since" -gt 50 ]; then
            echo "Limit approaching. Pushing empty keep-alive commit..."
            git commit --allow-empty -m "Automated keep-alive to prevent 60-day inactivity"
            git push
          else
            echo "No keep-alive needed yet."
          fi
